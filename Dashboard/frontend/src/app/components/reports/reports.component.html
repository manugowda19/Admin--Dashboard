<div class="reports-container">
  <div class="reports-header">
    <h1>Reports</h1>
    <p class="subtitle">Generate and download analytics reports</p>
  </div>

  <!-- Generate Report Section -->
  <mat-card class="generate-report-card">
    <mat-card-header>
      <mat-card-title>Generate Report</mat-card-title>
      <mat-card-subtitle>Create downloadable analytics reports in CSV or PDF format</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="reportForm" (ngSubmit)="generateReport()">
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Report Format</mat-label>
            <mat-select formControlName="format">
              <mat-option *ngFor="let option of reportFormatOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="reportForm.get('format')?.hasError('required')">
              Report format is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Date Range</mat-label>
            <mat-select formControlName="dateRange">
              <mat-option *ngFor="let option of dateRangeOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="reportForm.get('dateRange')?.hasError('required')">
              Date range is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Custom Date Range -->
        <div class="form-row" *ngIf="reportForm.get('dateRange')?.value === 'custom'">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Start Date</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="startDate">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
            <mat-error *ngIf="reportForm.get('startDate')?.hasError('required')">
              Start date is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>End Date</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="endDate">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
            <mat-error *ngIf="reportForm.get('endDate')?.hasError('required')">
              End date is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Include Metrics -->
        <div class="metrics-section">
          <h3>Include Metrics</h3>
          <div class="metrics-grid" formGroupName="metrics">
            <mat-checkbox
              *ngFor="let metric of metricsOptions"
              [formControlName]="metric.id">
              {{ metric.label }}
            </mat-checkbox>
          </div>
          <p class="metrics-hint">
            {{ getSelectedMetricsCount() }} of {{ metricsOptions.length }} metrics selected
          </p>
        </div>

        <div class="form-actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="isLoading || reportForm.invalid || getSelectedMetricsCount() === 0"
            class="generate-button">
            <mat-icon>download</mat-icon>
            <span>Generate & Download Report</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Report History Section -->
  <mat-card class="report-history-card">
    <mat-card-header>
      <mat-card-title>Report History</mat-card-title>
      <mat-card-subtitle>Previously generated reports</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container" *ngIf="!isLoading">
        <table mat-table [dataSource]="reportHistory" class="reports-table">
          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let report">
              <span class="report-type-badge" [class.csv]="report.type === 'CSV'" [class.pdf]="report.type === 'PDF'">
                {{ report.type }}
              </span>
            </td>
          </ng-container>

          <!-- Date Range Column -->
          <ng-container matColumnDef="dateRange">
            <th mat-header-cell *matHeaderCellDef>Date Range</th>
            <td mat-cell *matCellDef="let report">{{ report.dateRange }}</td>
          </ng-container>

          <!-- Generated Column -->
          <ng-container matColumnDef="generated">
            <th mat-header-cell *matHeaderCellDef>Generated</th>
            <td mat-cell *matCellDef="let report">
              {{ report.generated | date:'short' }}
            </td>
          </ng-container>

          <!-- Metrics Column -->
          <ng-container matColumnDef="metrics">
            <th mat-header-cell *matHeaderCellDef>Metrics</th>
            <td mat-cell *matCellDef="let report">
              <div class="metrics-list">
                <span class="metric-tag" *ngFor="let metric of report.metrics.slice(0, 3)">
                  {{ metric }}
                </span>
                <span class="metric-more" *ngIf="report.metrics.length > 3">
                  +{{ report.metrics.length - 3 }} more
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let report">
              <button mat-icon-button (click)="downloadReport(report)" matTooltip="Download">
                <mat-icon>download</mat-icon>
              </button>
              <button mat-icon-button (click)="deleteReport(report._id)" matTooltip="Delete" color="warn">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

          <!-- No data row -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">
              <div class="no-data-message">
                <mat-icon>description</mat-icon>
                <p>No reports generated yet. Create your first report above.</p>
              </div>
            </td>
          </tr>
        </table>
      </div>

      <div class="loading-container" *ngIf="isLoading">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading report history...</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>

